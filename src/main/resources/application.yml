spring:
  application:
    name: sentinelpay-fraud-engine
  profiles:
    active: dev  # Use dev profile for local development

---
# Development profile - For local IntelliJ + Docker services
spring:
  config:
    activate:
      on-profile: dev

  # R2DBC configuration for Postgres (Reactive)
  r2dbc:
    url: r2dbc:postgresql://localhost:5432/${POSTGRES_DB:frauddb}
    username: ${POSTGRES_USER:fraud_user}
    password: ${POSTGRES_PASSWORD:fraud_password}
    pool:
      initial-size: 10
      max-size: 20
      max-idle-time: 30m

  # Redis configuration
  data:
    redis:
      host: localhost
      port: 6379
      password: ${REDIS_PASSWORD:sentinelpay123}
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 5
          max-wait: 5000ms
        shutdown-timeout: 100ms
      connect-timeout: 2000ms
      timeout: 1000ms

  # Kafka configuration
  kafka:
    bootstrap-servers: localhost:9092
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      properties:
        spring.json.add.type.headers: false
    consumer:
      group-id: fraud-detection-group
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "com.sentinelpay.fraud.*"

  # Exclude Cassandra autoconfiguration
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.cassandra.CassandraAutoConfiguration
      - org.springframework.boot.autoconfigure.data.cassandra.CassandraDataAutoConfiguration
      - org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveDataAutoConfiguration

# Management & Health
management:
  health:
    cassandra:
      enabled: false  # We're not using Cassandra
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
      show-components: always
    metrics:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name}
    distribution:
      percentiles-histogram:
        http.server.requests: true

---
# Production profile - For Docker deployment
spring:
  config:
    activate:
      on-profile: prod

  # R2DBC configuration for Postgres (Production)
  r2dbc:
    url: r2dbc:postgresql://${POSTGRES_HOST:postgres}:${POSTGRES_PORT:5432}/${POSTGRES_DB:frauddb}
    username: ${POSTGRES_USER:fraud_user}
    password: ${POSTGRES_PASSWORD:fraud_password}
    pool:
      initial-size: 20
      max-size: 50
      max-idle-time: 30m

  # Redis configuration (Production)
  data:
    redis:
      host: ${REDIS_HOST:redis}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 5
          max-wait: 5000ms
        shutdown-timeout: 100ms
      connect-timeout: 2000ms
      timeout: 1000ms

  # Kafka configuration (Production)
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:kafka:29092}
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      properties:
        spring.json.add.type.headers: false
    consumer:
      group-id: fraud-detection-group
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "com.sentinelpay.fraud.*"

  # Exclude Cassandra
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.cassandra.CassandraAutoConfiguration
      - org.springframework.boot.autoconfigure.data.cassandra.CassandraDataAutoConfiguration
      - org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveDataAutoConfiguration

management:
  health:
    cassandra:
      enabled: false

---
# Resilience4j Configuration (All profiles)
resilience4j:
  circuitbreaker:
    instances:
      mlService:
        register-health-indicator: true
        sliding-window-type: COUNT_BASED
        sliding-window-size: 20
        minimum-number-of-calls: 10
        permitted-number-of-calls-in-half-open-state: 5
        wait-duration-in-open-state: 15s
        failure-rate-threshold: 50
      ruleEngine:
        register-health-indicator: true
        sliding-window-type: COUNT_BASED
        sliding-window-size: 50
        minimum-number-of-calls: 20
        failure-rate-threshold: 30
  timelimiter:
    instances:
      mlService:
        timeout-duration: 5s
      ruleEngine:
        timeout-duration: 2s

---
# Application Configuration (All profiles)
sentinelpay:
  fraud:
    decision-timeout-ms: 90000
    ml-service:
      url: ${ML_SERVICE_URL:http://localhost:8501}
      timeout-ms: 5000
    rule-engine:
      timeout-ms: 2000
    behavioral-analyzer:
      timeout-ms: 3000
    cache:
      ttl-minutes: 60
    velocity:
      windows:
        - duration: 1h
          max-transactions: 10
          ttl: 65m
        - duration: 24h
          max-transactions: 100
          ttl: 25h
        - duration: 7d
          max-transactions: 500
          ttl: 8d
    blacklist:
      ttl: 30d

---
# Logging Configuration
logging:
  level:
    com.sentinelpay.fraud: DEBUG
    org.springframework.data.redis: WARN
    org.springframework.data.r2dbc: DEBUG
    org.apache.kafka: WARN
    io.r2dbc.postgresql: INFO
  pattern:
    level: "%5p [${spring.application.name:},%X{traceId:-},%X{spanId:-}]"

---
# Server Configuration
server:
  port: 8080